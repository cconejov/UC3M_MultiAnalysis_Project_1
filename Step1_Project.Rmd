---
title: "Step1 Team Project Multivariate Analysis"
author: "Adrian White, Cesar Conejo, Xavier Bryant"
date: "12/6/2020"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_chunk$set(fig.width=10, fig.height=5)

# Libraries
library(ggplot2)
library(knitr)
library(corrplot)
library(rrcov)
library(factoextra)


# Dataset:
load('rda/clinical_trial_complete.rda')
source("scripts/functions/graph_functions.R")

# Deleting some categorical variables
X <- clinical_trial_complete[,-c(1,11,13,14,15,16,18)]

#X <- X[1:100,]

# Remove the file
rm(clinical_trial_complete)

# Remember: This add some log transformations:

color_1 <- "deepskyblue2"
color_2 <- "orange2"
color_3 <- "seagreen2"
color_4 <- "darkorchid4"
```

## Introduction data set

We have selected the [CRASH-2](http://biostat.mc.vanderbilt.edu/wiki/pub/Main/DataSets/crash2.html) data set provided by Vanderbilt School of Biostatistics for our project. It describes the outcome of a randomized controlled trial and economic valuation of the effects of tranexamic acid on death, vascular occlusive events, and transfusion requirement in bleeding trauma patients. Tranexamic acid reduces bleeding in trauma patients undergoing surgery but is an expensive treatment option. The trial's objective was to assess the effects and cost-effectiveness of an early administration of this medication. 

Participants of the study were adults with, or at risk of, significant bleeding within 8 hours of injury. Sample randomization was determined by the allocation of an eight-digit sequence randomly generated by a computer. Patients and staff were masked to the treatment allocation of the tranexamic acid.

We have adjusted the original data set to remove some variables that were not relevant to our investigation. We have removed variables regarding the exact surgical procedures administered to patients, various IDs, and details on the patient outcome. We removed the health outcome columns because of complications regarding missing data, where the boolean structure of the columns relating to specific outcomes, like stroke or pulmonary embolism, left a large number of cases with missing values. Instead, we added a boolean variable for a general outcome of survival to assess the efficacy of the procedure, rather than looking at particular health outcomes in post-surgery for living patients. 

We will be using variables regarding the sex, age, and injury of the patient as well as certain biometrics, like blood pressure, respiratory and heart rates, details on surgical blood transfusion, and a boolean variable on the survival of the patient. Our selection provides us with a balance of continuous and categorical variables, many of which are boolean, with minimal complications due to missing data.

### Summary variables in the data set

The variables in this dataset are the following:

1. sex: (Boolean) The sex of the patient (Male/Female)

2. age : (Numerical) Age of the patient(Years)

3. injurytime: (Numerical) Hours since injury (Hours)

4. injurytype:	(Categorical) Type of injury {Blunt, Penetrating, Blunt and Penetrating}

5. sbp: (Numerical) Systolic Blood Pressure (mmHg)

6. rr: (Numerical) Respiratory Rate (rate per minute)

7. cc: (Numerical) Central Capillary Refille Time (seconds)

8. hr: (Numerical) Heart Rate (rate per minute)

9. ndaysicu: (Numerical) Number of days in ICU (days)

10. ncell: (Numerical) Number of Units of Red Call Products Transfused.

11. Death: (Boolean) Indicator if the patient survived after the procedure


A summary of the data type is the following:

```{r echo=FALSE}
variable <- c("sex","age","injurytime","injurytype","sbp","rr","cc","hr","ndaysicu","ncell","death")

type_variable <- c("Qualitative","Quantitative","Quantitative","Qualitative","Quantitative","Quantitative","Quantitative","Quantitative","Quantitative","Quantitative","Qualitative")


sub_type_variable <- c("Nominal","Continuous","Continuous","Nominal","Continuous","Continuous","Continuous","Continuous","Discrete","Continuous","Nominal")

summary.methods <- data.frame(variable,
                              type_variable,
                              sub_type_variable,
                              row.names = NULL)
knitr::kable(summary.methods)
```

A review of the structure of the dataset is the following:

```{r echo=FALSE}
str(X[,-c(12:16)])
```

A summary of the values in the data set are:

```{r echo=FALSE}
summary(X[,-c(12:16)])
```

Finally, the list of different values by column is the following:

```{r echo=FALSE}
table <- apply(X[,-c(12:16)], 2, function(x) length(unique(x)))
kable(t(table),
      caption="Count of distinct values of each variable", 
      align="c")
```

\newpage

## Visual Analysis

First, we will review the distribution of the variables involve in the dataset

In the case of age, the figure \ref{fig:age} reflects how this variable appears to be largely weighted to the left, with lower ages featuring more frequently than those that are greater, possibly reflecting that younger people often take more risk and work higher at-risk occupations, raising their chance of experiencing trauma involving bleeding.

```{r age, fig.cap = "Distribution of age variable\\label{fig:age}", echo=FALSE}
plothist(col_name = "age", df = X, ylabtext = "All participants",  color_1, density_plot = FALSE)
```

The figure \ref{fig:injurytime} show the distribution of the variable Injury time. We can see how this variable is highly positive skewed with almost all values falling below ten minutes since the injury was experienced. This is likely due to the fact that in cases of serious injury victims are brought to the hospital quite quickly. Then, we apply a *log* transformation `log_injurytime = log(injurytime + 1)` to this variables as we can see in figure \ref{fig:loginjurytime}.

```{r injurytime, fig.cap = "Distribution of injurytime variable\\label{fig:injurytime}", echo=FALSE}
plothist(col_name = "injurytime", df = X, ylabtext = "All participants",  color_1, density_plot = FALSE)
```

```{r loginjurytime, fig.cap = "Distribution of the log injurytime variable\\label{fig:loginjurytime}", echo=FALSE}
plothist(col_name = "log_injurytime", df = X,ylabtext = "All participants", color_1, breaks = 10, density_plot = FALSE)
```

For *sbp* (Systolic Blood Pressure), the distribution is a fairly centrally balanced distribution around 90 mmHg. This is logical as a sample of biological characteristics observed in a population is likely to have most people around the mean and then a reasonably tight distribution of those who differ, similar to that of other biological features like height. Furthermore, most people are fairly young in the sample and therefore would have rates that deviant less from the norm, at a healthy level. The distribution is given by figure \ref{fig:sbp}.

```{r sbp, fig.cap = "Distribution of sbp (Systolic Blood Pressure)\\label{fig:sbp}", echo=FALSE}
plothist(col_name = "sbp", df = X, ylabtext = "All participants",  color_1, density_plot = FALSE)
```

In the case of *rr* (Respiratory Rate) appears, similar to sbp, resembling a moderately balanced distribution around 22 respirations per minute, although is weighted more to the right. The distribution of this variable is showed in figure \ref{fig:rr}. Taking a *log* transformation `log_rr = log(rr)`, we have the new distribution in figure \ref{fig:logrr}.

```{r rr, fig.cap = "Distribution of rr (Respiratory Rate)\\label{fig:rr}", echo=FALSE}
plothist(col_name = "rr", df = X, ylabtext = "All participants",  color_1, density_plot = FALSE)
```

```{r logrr, fig.cap = "Distribution of log transformation of rr (Respiratory Rate)\\label{fig:logrr}", echo=FALSE}
plothist(col_name = "log_rr", df = X,ylabtext = "All participants", color_1, breaks = 8 ,density_plot = FALSE)
```

In the case of *hr* (Heart rate), figure \ref{fig:hr} show that this distribution seems fairly balanced at around 110, similar to the variables above, like *sbp* and *rr*.

```{r hr, fig.cap = "Distribution of hh (hearth Rate)\\label{fig:hr}", echo=FALSE}
plothist(col_name = "hr", df = X, ylabtext = "All participants",  color_1, density_plot = FALSE)
```

For *cc* (Central capillary) refill has 75% of the observations below of 4 as we can appreciate in figure \ref{fig:cc}. However, the distribution is right-skewed. As a result, we apply a *log* transformation `log_cc = log(cc)` that is given in figure \ref{fig:logcc}.

```{r cc, fig.cap = "Distribution of cc (Central capillary)\\label{fig:cc}", echo=FALSE}
plothist(col_name = "cc", df = X, ylabtext = "All participants",  color_1, density_plot = FALSE)
```

```{r logcc, fig.cap = "Distribution of log transformation of cc (Central capillary)\\label{fig:logcc}", echo=FALSE}
plothist(col_name = "log_cc", df = X,ylabtext = "All participants", color_1, breaks = 8 ,density_plot = FALSE)
```

The figure \ref{fig:ndaysicu} shows the distribution of the *ndaysicu:* variable. In this case, the distribution is heavily weighted to the left and right-skewed. Most patients it seems, with injuries at high risk of bleeding, do not often need to remain in the hospital for long. The transformed distribution `log_ndaysicu = log(ndaysicu + 1)` is given in the figure \ref{fig:logndaysicu}.

```{r ndaysicu, fig.cap = "Distribution of ndaysicu\\label{fig:ndaysicu}", echo=FALSE}
plothist(col_name = "ndaysicu", df = X, ylabtext = "All participants",  color_1, density_plot = FALSE)
```

```{r logndaysicu, fig.cap = "Distribution of log ndaysicu\\label{fig:logndaysicu}", echo=FALSE}
plothist(col_name = "log_ndaysicu", df = X,ylabtext = "All participants", color_1, breaks = 10, density_plot = FALSE)
```

Finally, for the *ncell*distribution is weighted to the left with a median of 3 as we can appreciate in the figure \ref{fig:ncell}. The conclusion of this it that with many patients, only needing a small number of or zero units of red cell products transfused. Due to this variable is highly right skewed, we apply the *log* transformation  `log_ncell = log(ncell + 1)` of the figure \ref{fig:logncell}.

```{r ncell, fig.cap = "Distribution of ncell\\label{fig:ncell}", echo=FALSE}
plothist(col_name = "ncell", df = X, ylabtext = "All participants",  color_1, density_plot = FALSE)
```

```{r logncell, fig.cap = "Distribution of log ncell\\label{fig:logncell}", echo=FALSE}
plothist(col_name = "log_ncell", df = X, ylabtext = "All participants",  color_1, density_plot = FALSE)
```

For the categorical variables, we will focus on the distributions of deaths. The figure \ref{fig:deaths}, shows that approximately for each death, 4 people survive. In the context of this problem, if we have an unbalanced proportion of people that survive can be considered as a sign that the drugs works.

```{r deaths, fig.cap = "Distribution of deaths\\label{fig:deaths}", echo=FALSE}
ggplot(X) +
  geom_bar(aes( x = death, fill = death)) +
  labs(title = "Distribution of death") 
```

\newpage

On the other hand, we can study some relations of the quantitative variables in terms of the categorical variable death. Figure \ref{fig:agedeath} ...

Lorem ipsum dolor sit amet, consectetur adipiscing elit, sed do eiusmod tempor incididunt ut labore et dolore magna aliqua. Ut enim ad minim veniam, quis nostrud exercitation ullamco laboris nisi ut aliquip ex ea commodo consequat.

```{r agedeath, fig.cap = "Distribution of age in terms of death\\label{fig:agedeath}", echo=FALSE}
plothist_factor("age", "death", X, "Death", color_2, color_3, density_plot = FALSE)
```

Figure \ref{fig:loginjurytimedeath} ....

Lorem ipsum dolor sit amet, consectetur adipiscing elit, sed do eiusmod tempor incididunt ut labore et dolore magna aliqua. Ut enim ad minim veniam, quis nostrud exercitation ullamco laboris nisi ut aliquip ex ea commodo consequat.

```{r loginjurytimedeath, fig.cap = "Distribution of the log injurytime in terms of death\\label{fig:loginjurytimedeath}", echo=FALSE}
plothist_factor("log_injurytime", "death", X, "Death", color_2, color_3, density_plot = FALSE)
```

Figure \ref{fig:sbpdeath} ....

Lorem ipsum dolor sit amet, consectetur adipiscing elit, sed do eiusmod tempor incididunt ut labore et dolore magna aliqua. Ut enim ad minim veniam, quis nostrud exercitation ullamco laboris nisi ut aliquip ex ea commodo consequat.

```{r sbpdeath, fig.cap = "Distribution of sbp (Systolic Blood Pressure) in terms of death\\label{fig:sbpdeath}", echo=FALSE}
plothist_factor("sbp", "death", X, "Death", color_2, color_3, density_plot = FALSE)
```

Figure \ref{fig:loginjurytimedeath} ...

Lorem ipsum dolor sit amet, consectetur adipiscing elit, sed do eiusmod tempor incididunt ut labore et dolore magna aliqua. Ut enim ad minim veniam, quis nostrud exercitation ullamco laboris nisi ut aliquip ex ea commodo consequat.

```{r logrrdeath, fig.cap = "Distribution of log transformation of rr (Respiratory Rate) in terms of death\\label{fig:logrrdeath}", echo=FALSE}
plothist_factor("log_rr", "death", X, "Death", color_2, color_3, density_plot = FALSE)
```

Figure \ref{fig:hrdeath} ...

Lorem ipsum dolor sit amet, consectetur adipiscing elit, sed do eiusmod tempor incididunt ut labore et dolore magna aliqua. Ut enim ad minim veniam, quis nostrud exercitation ullamco laboris nisi ut aliquip ex ea commodo consequat.

```{r hrdeath, fig.cap = "Distribution of hh (hearth Rate) in terms of death\\label{fig:hrdeath}", echo=FALSE}
plothist_factor("hr", "death", X, "Death", color_2, color_3, density_plot = FALSE)
```

Figure \ref{fig:logccdeath} ...

Lorem ipsum dolor sit amet, consectetur adipiscing elit, sed do eiusmod tempor incididunt ut labore et dolore magna aliqua. Ut enim ad minim veniam, quis nostrud exercitation ullamco laboris nisi ut aliquip ex ea commodo consequat.

```{r logccdeath, fig.cap = "Distribution of log transformation of cc (Central capillary) in terms of death\\label{fig:logccdeath}", echo=FALSE}
plothist_factor("log_cc", "death", X, "Death", color_2, color_3, density_plot = FALSE)
```

Figure \ref{fig:logndaysicudeath}

Lorem ipsum dolor sit amet, consectetur adipiscing elit, sed do eiusmod tempor incididunt ut labore et dolore magna aliqua. Ut enim ad minim veniam, quis nostrud exercitation ullamco laboris nisi ut aliquip ex ea commodo consequat.

```{r logndaysicudeath, fig.cap = "Distribution of log ndaysicu in terms of death\\label{fig:logndaysicudeath}", echo=FALSE}
plothist_factor("log_ndaysicu", "death", X, "Death", color_2, color_3, density_plot = FALSE)
```

Figure \ref{fig:logncelldeath} ...

Lorem ipsum dolor sit amet, consectetur adipiscing elit, sed do eiusmod tempor incididunt ut labore et dolore magna aliqua. Ut enim ad minim veniam, quis nostrud exercitation ullamco laboris nisi ut aliquip ex ea commodo consequat.

```{r logncelldeath, fig.cap = "Distribution of log ncell in terms of death\\label{fig:logncelldeath}", echo=FALSE}
plothist_factor("log_ncell", "death", X, "Death", color_2, color_3, density_plot = FALSE)
```

Finally, the scatter plot in figure 23 ...

Lorem ipsum dolor sit amet, consectetur adipiscing elit, sed do eiusmod tempor incididunt ut labore et dolore magna aliqua. Ut enim ad minim veniam, quis nostrud exercitation ullamco laboris nisi ut aliquip ex ea commodo consequat.

![Scatter plot of all quantitiative variables](figure_output/pairs_death.png)

The PCP plot in figure 24...

Lorem ipsum dolor sit amet, consectetur adipiscing elit, sed do eiusmod tempor incididunt ut labore et dolore magna aliqua. Ut enim ad minim veniam, quis nostrud exercitation ullamco laboris nisi ut aliquip ex ea commodo consequat.

![PCP plot of all quantitiative variables](figure_output/pcp_death.png)

The Andrews' plot in figure 25...

Lorem ipsum dolor sit amet, consectetur adipiscing elit, sed do eiusmod tempor incididunt ut labore et dolore magna aliqua. Ut enim ad minim veniam, quis nostrud exercitation ullamco laboris nisi ut aliquip ex ea commodo consequat.

![Andrews' plot of all quantitiative variables](figure_output/andrew_death.png)

In conclusion ....

Lorem ipsum dolor sit amet, consectetur adipiscing elit, sed do eiusmod tempor incididunt ut labore et dolore magna aliqua. Ut enim ad minim veniam, quis nostrud exercitation ullamco laboris nisi ut aliquip ex ea commodo consequat.

In the next section we will make some inference using sample estimators of mean, covariance, correlation

\newpage

## Sample Estimators

### Sample mean

All population...

Lorem ipsum dolor sit amet, consectetur adipiscing elit, sed do eiusmod tempor incididunt ut labore et dolore magna aliqua. Ut enim ad minim veniam, quis nostrud exercitation ullamco laboris nisi ut aliquip ex ea commodo consequat.

```{r, echo=FALSE}
X <- X[,-c(3,6,7,9,10)]
X_quan <- X[,-c(1,3,6)]

m <- colMeans(X_quan)

knitr::kable(t(m),
      row.names = FALSE,
      caption = "Sample mean",
      align="c")
```

Population with death = 1 ...

Lorem ipsum dolor sit amet, consectetur adipiscing elit, sed do eiusmod tempor incididunt ut labore et dolore magna aliqua. Ut enim ad minim veniam, quis nostrud exercitation ullamco laboris nisi ut aliquip ex ea commodo consequat.

```{r, echo=FALSE}
X_death <- X_quan[X$death==1,]
m_death <- colMeans(X_death)

knitr::kable(t(m_death),
      row.names = FALSE,
      caption = "Sample mean death",
      align="c")
```

Survival population

Lorem ipsum dolor sit amet, consectetur adipiscing elit, sed do eiusmod tempor incididunt ut labore et dolore magna aliqua. Ut enim ad minim veniam, quis nostrud exercitation ullamco laboris nisi ut aliquip ex ea commodo consequat.

```{r, echo=FALSE}
X_life <- X_quan[X$death==0,]
m_life <- colMeans(X_life)

knitr::kable(t(m_life),
      row.names = FALSE,
      caption = "Sample mean survive",
      align="c")
```

Lorem ipsum dolor sit amet, consectetur adipiscing elit, sed do eiusmod tempor incididunt ut labore et dolore magna aliqua. Ut enim ad minim veniam, quis nostrud exercitation ullamco laboris nisi ut aliquip ex ea commodo consequat.

\newpage

### Sample covariance

Lorem ipsum dolor sit amet, consectetur adipiscing elit, sed do eiusmod tempor incididunt ut labore et dolore magna aliqua. Ut enim ad minim veniam, quis nostrud exercitation ullamco laboris nisi ut aliquip ex ea commodo consequat.

```{r, echo=FALSE}
S <- cov(X_quan)

knitr::kable(S,
      row.names = FALSE,
      caption = "Sample covariance matrix",
      align="c")
```

Lorem ipsum dolor sit amet, consectetur adipiscing elit, sed do eiusmod tempor incididunt ut labore et dolore magna aliqua. Ut enim ad minim veniam, quis nostrud exercitation ullamco laboris nisi ut aliquip ex ea commodo consequat.

```{r, echo=FALSE}
S_death <- cov(X_death)

knitr::kable(S_death,
      row.names = FALSE,
      caption = "Sample covariance matrix death patients",
      align="c")
```

Lorem ipsum dolor sit amet, consectetur adipiscing elit, sed do eiusmod tempor incididunt ut labore et dolore magna aliqua. Ut enim ad minim veniam, quis nostrud exercitation ullamco laboris nisi ut aliquip ex ea commodo consequat.

```{r, echo=FALSE}
S_life <- cov(X_life)

knitr::kable(S_life,
      row.names = FALSE,
      caption = "Sample covariance matrix survival patients",
      align="c")
```

Lorem ipsum dolor sit amet, consectetur adipiscing elit, sed do eiusmod tempor incididunt ut labore et dolore magna aliqua. Ut enim ad minim veniam, quis nostrud exercitation ullamco laboris nisi ut aliquip ex ea commodo consequat.

\newpage

### Sample correlation

Lorem ipsum dolor sit amet, consectetur adipiscing elit, sed do eiusmod tempor incididunt ut labore et dolore magna aliqua. Ut enim ad minim veniam, quis nostrud exercitation ullamco laboris nisi ut aliquip ex ea commodo consequat.

```{r, echo=FALSE}
R <- cor(X_quan)

knitr::kable(R,
      row.names = FALSE,
      caption = "Sample covariance matrix",
      align="c")
```

Figure \ref{fig:corr} ...

Lorem ipsum dolor sit amet, consectetur adipiscing elit, sed do eiusmod tempor incididunt ut labore et dolore magna aliqua. Ut enim ad minim veniam, quis nostrud exercitation ullamco laboris nisi ut aliquip ex ea commodo consequat.

```{r corr, fig.cap = "Sample Correlation Crash2 Dataset\\label{fig:corr}", echo=FALSE}
corrplot(R)
```

Lorem ipsum dolor sit amet, consectetur adipiscing elit, sed do eiusmod tempor incididunt ut labore et dolore magna aliqua. Ut enim ad minim veniam, quis nostrud exercitation ullamco laboris nisi ut aliquip ex ea commodo consequat.

```{r, echo=FALSE}
R_death <- cor(X_death)

knitr::kable(R_death,
      row.names = FALSE,
      caption = "Sample covariance matrix death patients",
      align="c")
```

Lorem ipsum dolor sit amet, consectetur adipiscing elit, sed do eiusmod tempor incididunt ut labore et dolore magna aliqua. Ut enim ad minim veniam, quis nostrud exercitation ullamco laboris nisi ut aliquip ex ea commodo consequat.

```{r, echo=FALSE}
R_life <- cor(X_life)

knitr::kable(R_life,
      row.names = FALSE,
      caption = "Sample covariance matrix survival patients",
      align="c")
```

Figure \ref{fig:corrgroup}...

Lorem ipsum dolor sit amet, consectetur adipiscing elit, sed do eiusmod tempor incididunt ut labore et dolore magna aliqua. Ut enim ad minim veniam, quis nostrud exercitation ullamco laboris nisi ut aliquip ex ea commodo consequat.

```{r corrgroup, fig.cap = "Sample Correlation for death and survival patients from Crash2 Dataset\\label{fig:corrgroup}", echo=FALSE}
par(mfrow=c(1,2))
corrplot(R_death)
corrplot(R_life)
```

Lorem ipsum dolor sit amet, consectetur adipiscing elit, sed do eiusmod tempor incididunt ut labore et dolore magna aliqua. Ut enim ad minim veniam, quis nostrud exercitation ullamco laboris nisi ut aliquip ex ea commodo consequat.

### Outliers

Lorem ipsum dolor sit amet, consectetur adipiscing elit, sed do eiusmod tempor incididunt ut labore et dolore magna aliqua. Ut enim ad minim veniam, quis nostrud exercitation ullamco laboris nisi ut aliquip ex ea commodo consequat.

```{r, echo=FALSE}
MCD_est <- CovMcd(X_quan, alpha=0.75, nsamp="deterministic")
m_MCD <- MCD_est$center

knitr::kable(t(m_MCD),
      row.names = FALSE,
      caption = "Sample robust media all population",
      align="c")
```

Comparison of the eigenvalues of the covariance matrix for sample and robust is given by figure \ref{fig:robust} ...

Lorem ipsum dolor sit amet, consectetur adipiscing elit, sed do eiusmod tempor incididunt ut labore et dolore magna aliqua. Ut enim ad minim veniam, quis nostrud exercitation ullamco laboris nisi ut aliquip ex ea commodo consequat.

```{r robust, fig.cap = "Comparison eigenvalues sample and robust covariance\\label{fig:robust}", echo=FALSE}
S_MCD <- MCD_est$cov
R_MCD <- cov2cor(S_MCD)
eval_S <- eigen(S)$values
eval_S_MCD <- eigen(S_MCD)$values

min_y <- min(cbind(eval_S,eval_S_MCD)) - 1
max_y <- max(cbind(eval_S,eval_S_MCD)) + 1

plot(1:8,
     eval_S,
     col=color_1,
     type="b",
     xlab="Number",
     ylab="Eigenvalues",
     pch=19,
     ylim=c(min_y,max_y),
     main="Comparison of eigenvalues")
points(1:8,
       eval_S_MCD,
       col=color_2,
       type="b",
       pch=19)
legend(5,600,
       legend=c("Eigenvalues of S","Eigenvalues of S MCD"),
       col=c(color_1,color_2),
       lty=1,
       cex=1.2)
```

Lorem ipsum dolor sit amet, consectetur adipiscing elit, sed do eiusmod tempor incididunt ut labore et dolore magna aliqua. Ut enim ad minim veniam, quis nostrud exercitation ullamco laboris nisi ut aliquip ex ea commodo consequat.

```{r corrout, fig.cap = "Correlation all population and MCD correlation\\label{fig:corrout}", echo=FALSE}
par(mfrow=c(1,2))
corrplot(R)
corrplot(R_MCD)
```


figure \ref{fig:corrout} Lorem ipsum dolor sit amet, consectetur adipiscing elit, sed do eiusmod tempor incididunt ut labore et dolore magna aliqua. Ut enim ad minim veniam, quis nostrud exercitation ullamco laboris nisi ut aliquip ex ea commodo consequat.


\newpage


## Principal Component Analysis

Lorem ipsum dolor sit amet, consectetur adipiscing elit, sed do eiusmod tempor incididunt ut labore et dolore magna aliqua. Ut enim ad minim veniam, quis nostrud exercitation ullamco laboris nisi ut aliquip ex ea commodo consequat.

## PCA Complete dataset

![First two PCs based on the sample covariance all population](figure_output/pca_death.png)


figure \ref{fig:l1pc}...

Lorem ipsum dolor sit amet, consectetur adipiscing elit, sed do eiusmod tempor incididunt ut labore et dolore magna aliqua. Ut enim ad minim veniam, quis nostrud exercitation ullamco laboris nisi ut aliquip ex ea commodo consequat.

```{r l1pc, fig.cap = "Loadings for the first PC\\label{fig:l1pc}", echo=FALSE}
# Categorical variables
Y <- X[,c(1,3,6)]
X <- X_quan
n <- nrow(X)
p <- ncol(X)
X_pcs <- prcomp(X,scale=TRUE)


plot(1:p,X_pcs$rotation[,1],pch=19,col=color_1,main="Weights for the first PC",
     xlab="Variables",ylab="Score")
abline(h=0)
text(1:p,X_pcs$rotation[,1],labels=colnames(X),pos=1,col=color_4,cex=0.75)
```


figure \ref{fig:l1pc}...

Lorem ipsum dolor sit amet, consectetur adipiscing elit, sed do eiusmod tempor incididunt ut labore et dolore magna aliqua. Ut enim ad minim veniam, quis nostrud exercitation ullamco laboris nisi ut aliquip ex ea commodo consequat.

```{r l2pc, fig.cap = "Loadings for the second PC\\label{fig:l2pc}", echo=FALSE}
plot(1:p,X_pcs$rotation[,2],pch=19,col=color_1,main="Weights for the second PC",
     xlab="Variables",ylab="Score")
abline(h=0)
text(1:p,X_pcs$rotation[,2],labels=colnames(X),pos=1,col=color_4,cex=0.75)
```


figure \ref{fig:l3pc}...

Lorem ipsum dolor sit amet, consectetur adipiscing elit, sed do eiusmod tempor incididunt ut labore et dolore magna aliqua. Ut enim ad minim veniam, quis nostrud exercitation ullamco laboris nisi ut aliquip ex ea commodo consequat.

```{r l3pc, fig.cap = "Loadings for the first two PC\\label{fig:l3pc}", echo=FALSE}
plot(1:p,X_pcs$rotation[,2],pch=19,col=color_1,main="Weights for the second PC",
     xlab="Variables",ylab="Score")
abline(h=0)
text(1:p,X_pcs$rotation[,2],labels=colnames(X),pos=1,col=color_4,cex=0.75)
```


![PC Scores and PC loading all population](figure_output/pca_biplot.png)

figure \ref{fig:pcaeigv}...

Lorem ipsum dolor sit amet, consectetur adipiscing elit, sed do eiusmod tempor incididunt ut labore et dolore magna aliqua. Ut enim ad minim veniam, quis nostrud exercitation ullamco laboris nisi ut aliquip ex ea commodo consequat.

```{r pcaeigv, fig.cap = "Eigenvalues of the sample correlation matrix\\label{fig:pcaeigv}", echo=FALSE}
fviz_eig(X_pcs,ncp=17,addlabels=T,barfill=color_1,barcolor=`color_4`)
```

Lorem ipsum dolor sit amet, consectetur adipiscing elit, sed do eiusmod tempor incididunt ut labore et dolore magna aliqua. Ut enim ad minim veniam, quis nostrud exercitation ullamco laboris nisi ut aliquip ex ea commodo consequat.


![PC Scores and PC loading all population](figure_output/pca_4pc2.png)

Lorem ipsum dolor sit amet, consectetur adipiscing elit, sed do eiusmod tempor incididunt ut labore et dolore magna aliqua. Ut enim ad minim veniam, quis nostrud exercitation ullamco laboris nisi ut aliquip ex ea commodo consequat.

figure \ref{fig:corrpc}...

```{r corrpc, fig.cap = "Correlation between dataset and all PC and the first 4 PCs\\label{fig:corrpc}", echo=FALSE}
par(mfrow=c(1,2))
corrplot(cor(X,X_pcs$x),is.corr=T)
corrplot(cor(X,X_pcs$x[,1:4]),is.corr=T)
```

**IS NECESSARY TO DO THE SAME BY CLASS?**

Lorem ipsum dolor sit amet, consectetur adipiscing elit, sed do eiusmod tempor incididunt ut labore et dolore magna aliqua. Ut enim ad minim veniam, quis nostrud exercitation ullamco laboris nisi ut aliquip ex ea commodo consequat.


\newpage

## PCA by Category

Lorem ipsum dolor sit amet, consectetur adipiscing elit, sed do eiusmod tempor incididunt ut labore et dolore magna aliqua. Ut enim ad minim veniam, quis nostrud exercitation ullamco laboris nisi ut aliquip ex ea commodo consequat.


Important. For these plot the groups are now female (blue) and male (gray)

![PC Scores and PC loading all population](figure_output/pca_groups.png)

Lorem ipsum dolor sit amet, consectetur adipiscing elit, sed do eiusmod tempor incididunt ut labore et dolore magna aliqua. Ut enim ad minim veniam, quis nostrud exercitation ullamco laboris nisi ut aliquip ex ea commodo consequat.


figure \ref{fig:l1pcgrp}...

```{r l1pcgrp, fig.cap = "Loadings for the first PC by death and survival patients\\label{fig:l1pcgrp}", echo=FALSE}
load('rda/clinical_trial_complete.rda')
X <- clinical_trial_complete[,-c(1,11,13,14,15,16,18)]

## Population: Death
X_death <- X[X$death == 1,]
X_death <- X_death[,-c(3,6,7,9,10)]

Y_death <- X_death[,c(1,3,6)]
X_death <- X_death[,-c(1,3,6)]

n_death <- nrow(X_death)
p_death <- ncol(X_death)

X_pcs_death <- prcomp(X_death,scale=TRUE)


## Survival

X_surv <- X[X$death == 0,]
X_surv <- X_surv[,-c(3,6,7,9,10)]

Y_surv <- X_surv[,c(1,3,6)]
X_surv <- X_surv[,-c(1,3,6)]

n_surv <- nrow(X_surv)
p_surv <- ncol(X_surv)


X_pcs_surv <- prcomp(X_surv,scale=TRUE)


par(mfrow=c(1,2))
plot(1:p_death,X_pcs_death$rotation[,1],pch=19,col=color_1,main="Weights for the first PC death patients",
     xlab="Variables",ylab="Score")
abline(h=0)
text(1:p_death,X_pcs_death$rotation[,1],labels=colnames(X_death),pos=1,col=color_4,cex=0.75)

plot(1:p_surv,X_pcs_surv$rotation[,1],pch=19,col=color_1,main="Weights for the first PC survival patients",
     xlab="Variables",ylab="Score")
abline(h=0)
text(1:p_surv,X_pcs_surv$rotation[,1],labels=colnames(X_surv),pos=1,col=color_4,cex=0.75)
```


figure \ref{fig:l2pcgr}...

Lorem ipsum dolor sit amet, consectetur adipiscing elit, sed do eiusmod tempor incididunt ut labore et dolore magna aliqua. Ut enim ad minim veniam, quis nostrud exercitation ullamco laboris nisi ut aliquip ex ea commodo consequat.

```{r l2pcgr, fig.cap = "Loadings for the second PC by death and survival patients\\label{fig:l2pcgr}", echo=FALSE}
par(mfrow=c(1,2))
plot(1:p_death,X_pcs_death$rotation[,2],pch=19,col=color_1,main="Weights for the second PC death patients",
     xlab="Variables",ylab="Score")
abline(h=0)
text(1:p_death,X_pcs_death$rotation[,2],labels=colnames(X_death),pos=1,col=color_4,cex=0.75)

plot(1:p_surv,X_pcs_surv$rotation[,2],pch=19,col=color_1,main="Weights for the second PC survival patients",
     xlab="Variables",ylab="Score")
abline(h=0)
text(1:p_surv,X_pcs_surv$rotation[,2],labels=colnames(X_surv),pos=1,col=color_4,cex=0.75)
```

Lorem ipsum dolor sit amet, consectetur adipiscing elit, sed do eiusmod tempor incididunt ut labore et dolore magna aliqua. Ut enim ad minim veniam, quis nostrud exercitation ullamco laboris nisi ut aliquip ex ea commodo consequat.


![PC Scores and PC loading all population for death and survival patiens](figure_output/pca_group_biplot)


Lorem ipsum dolor sit amet, consectetur adipiscing elit, sed do eiusmod tempor incididunt ut labore et dolore magna aliqua. Ut enim ad minim veniam, quis nostrud exercitation ullamco laboris nisi ut aliquip ex ea commodo consequat.

Figures \ref{fig:pcaeigvgr1} and  \ref{fig:pcaeigvgr2} ... 

```{r pcaeigvgr1, fig.cap = "Eigenvalues of the sample correlation matrix for death patients\\label{fig:pcaeigvgr1}", echo=FALSE}
fviz_eig(X_pcs_death,ncp=8,addlabels=T,barfill=color_1,barcolor=`color_4`)
```


```{r pcaeigvgr2, fig.cap = "Eigenvalues of the sample correlation matrix for survival patients\\label{fig:pcaeigvgr2}", echo=FALSE}
fviz_eig(X_pcs_surv,ncp=8,addlabels=T,barfill=color_1,barcolor=`color_4`)
```

Lorem ipsum dolor sit amet, consectetur adipiscing elit, sed do eiusmod tempor incididunt ut labore et dolore magna aliqua. Ut enim ad minim veniam, quis nostrud exercitation ullamco laboris nisi ut aliquip ex ea commodo consequat.

Lorem ipsum dolor sit amet, consectetur adipiscing elit, sed do eiusmod tempor incididunt ut labore et dolore magna aliqua. Ut enim ad minim veniam, quis nostrud exercitation ullamco laboris nisi ut aliquip ex ea commodo consequat.


\newpage

# Conclusions

Lorem ipsum dolor sit amet, consectetur adipiscing elit, sed do eiusmod tempor incididunt ut labore et dolore magna aliqua. Ut enim ad minim veniam, quis nostrud exercitation ullamco laboris nisi ut aliquip ex ea commodo consequat.

Lorem ipsum dolor sit amet, consectetur adipiscing elit, sed do eiusmod tempor incididunt ut labore et dolore magna aliqua. Ut enim ad minim veniam, quis nostrud exercitation ullamco laboris nisi ut aliquip ex ea commodo consequat.

Lorem ipsum dolor sit amet, consectetur adipiscing elit, sed do eiusmod tempor incididunt ut labore et dolore magna aliqua. Ut enim ad minim veniam, quis nostrud exercitation ullamco laboris nisi ut aliquip ex ea commodo consequat.